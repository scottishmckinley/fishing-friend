<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Angler OS v9.9 - Cloud Sync</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --navy: #050b14; --card: #121c2b; --sea: #34e89e; --gold: #f4af1b; --white: #f1f2f6; --text: #cbd5e0; --red: #ff4757; --border: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--navy); margin: 0; padding: 10px; color: var(--text); }
        .app-container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
        
        /* Modal Pop-up Styling */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: var(--card); border: 2px solid var(--sea); margin: 20% auto; padding: 20px; width: 80%; border-radius: 20px; text-align: center; }

        .drawer { display: none; background: var(--card); border: 1px solid var(--gold); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 20px; margin-bottom: 15px; position: relative; }
        .hud-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .hud-item { background: var(--card); padding: 12px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .label { font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: 800; display: block; }
        .val { font-size: 1.1rem; font-weight: bold; color: var(--white); }
        .btn-main { width: 100%; background: var(--sea); color: var(--navy); border: none; padding: 14px; border-radius: 12px; font-weight: 800; cursor: pointer; margin-bottom: 10px; }
        .btn-sub { background: var(--card); border: 1px solid var(--border); color: var(--gold); padding: 10px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; cursor: pointer; }
        
        /* Forms */
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid var(--border); border-radius: 10px; background: var(--navy); color: var(--white); box-sizing: border-box; }
        #map { height: 160px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 10px; }
        #toast { visibility: hidden; min-width: 250px; background: var(--gold); color: var(--navy); text-align: center; border-radius: 10px; padding: 12px; position: fixed; z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: 800; }
        #toast.show { visibility: visible; }
    </style>
</head>
<body>

<div id="toast">Message</div>

<div id="totalsModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--gold)">Session Summary</h2>
        <div id="sessionBody" style="text-align: left; margin: 15px 0;"></div>
        <button class="btn-main" onclick="toggleModal('totalsModal')">CLOSE</button>
    </div>
</div>

<div class="app-container">
    <div style="text-align:center;"><h1>ANGLER<span>OS</span></h1></div>

    <div id="authBox" class="card">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pw" placeholder="Password">
        <div style="display:flex; gap:10px;">
            <button class="btn-main" onclick="handleSignUp()">SIGN UP</button>
            <button class="btn-main" style="background:var(--gold)" onclick="handleLogin()">LOGIN</button>
        </div>
        <p id="userEmail" style="font-size:0.7rem; text-align:center;"></p>
    </div>

    <div class="hud-grid">
        <button class="btn-sub" onclick="toggle('helpBox')">üìò HANDBOOK</button>
        <button class="btn-sub" onclick="showSessionPopUp()">üìä TOTALS</button>
    </div>

    <div id="helpBox" class="drawer">
        <h4 style="color:var(--gold); margin:0;">üåä FISHING INTEL</h4>
        <p style="font-size:0.75rem; color:var(--text);">
            ‚Ä¢ <b>Tides:</b> Best +/- 2hrs from High Tide.<br>
            ‚Ä¢ <b>Pressure:</b> 1013hPa+ is stable.<br>
            ‚Ä¢ <b>Flow:</b> 1.5 - 3.0 kn feeding zone.
        </p>
        <p style="font-size:0.65rem; color:#64748b;">
            <b>Instructions:</b> Use JSON export to back up your history locally. Sign in to sync your data automatically across devices.
        </p>
    </div>

    <div id="map"></div>
    <button class="btn-main" onclick="syncGPS()">üìç SYNC TIDE & WEATHER</button>

    <div class="card" id="logForm">
        <input type="file" id="cam" accept="image/*" style="display:none" onchange="previewImg(event)">
        <button class="btn-sub" style="width:100%; margin-bottom:10px;" onclick="document.getElementById('cam').click()">üì∏ ADD PHOTO</button>
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:8px;">
            <input type="text" id="sp" placeholder="Species">
            <input type="number" id="wt" placeholder="lb">
        </div>
        <textarea id="notes" placeholder="Notes & Rig setup..."></textarea>
        <button class="btn-main" id="saveBtn" onclick="saveToCloud()">üíæ SAVE TO CLOUD</button>
    </div>

    <div id="diary"></div>
</div>

<script>
    // REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_ID",
        appId: "YOUR_APP_ID"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let catches = [];

    // Auth Listeners
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('userEmail').innerText = "Logged in as: " + user.email;
            document.getElementById('authBox').style.display = "none";
            loadFromCloud();
        } else {
            currentUser = null;
            document.getElementById('authBox').style.display = "block";
        }
    });

    async function handleSignUp() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pw').value;
        try { await auth.createUserWithEmailAndPassword(e, p); notify("Account Created!"); } catch(err) { notify(err.message); }
    }

    async function handleLogin() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pw').value;
        try { await auth.signInWithEmailAndPassword(e, p); notify("Welcome Back!"); } catch(err) { notify(err.message); }
    }

    async function saveToCloud() {
        if (!currentUser) return notify("Please Login First");
        const species = document.getElementById('sp').value.toUpperCase();
        const weight = parseFloat(document.getElementById('wt').value) || 0;
        
        const catchData = {
            userId: currentUser.uid,
            sp: species,
            wt: weight,
            dt: new Date().toLocaleDateString('en-GB'),
            tm: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            loc: env.port || "Unknown",
            notes: document.getElementById('notes').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection("catches").add(catchData);
            notify("Saved to Cloud!");
            clearForm();
            loadFromCloud();
        } catch(err) { notify("Save Error"); }
    }

    async function loadFromCloud() {
        const snapshot = await db.collection("catches")
            .where("userId", "==", currentUser.uid)
            .orderBy("timestamp", "desc").get();
        
        catches = snapshot.docs.map(doc => doc.data());
        renderDiary();
    }

    function showSessionPopUp() {
        const today = new Date().toLocaleDateString('en-GB');
        const session = catches.filter(c => c.dt === today);
        const total = session.reduce((s, c) => s + (c.wt || 0), 0);

        let html = `<p><b>Date:</b> ${today}</p><hr>`;
        session.forEach(c => html += `<div style="display:flex; justify-content:space-between;"><span>${c.sp}</span><span>${c.wt}lb</span></div>`);
        html += `<hr><div style="color:var(--sea); font-weight:bold; display:flex; justify-content:space-between;"><span>TOTAL</span><span>${total.toFixed(2)}lb</span></div>`;
        
        document.getElementById('sessionBody').innerHTML = html;
        toggleModal('totalsModal');
    }

    function toggleModal(id) {
        const m = document.getElementById(id);
        m.style.display = (m.style.display === "block") ? "none" : "block";
    }

    function notify(m) {
        const t = document.getElementById("toast");
        t.innerText = m;
        t.className = "show";
        setTimeout(() => t.className = "", 3000);
    }

    function toggle(id) {
        const e = document.getElementById(id);
        e.style.display = e.style.display === 'block' ? 'none' : 'block';
    }

    function clearForm() {
        ["sp", "wt", "notes"].forEach(id => document.getElementById(id).value = "");
    }
    
    // ... (Keep existing Map, Tide, and Weather Logic from v9.8) ...
</script>
</body>
</html>
