<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Angler OS Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { 
            --navy: #050b14; --card: #121c2b; --sea: #34e89e; 
            --gold: #f4af1b; --white: #f1f2f6; --text: #cbd5e0; 
            --red: #ff4757; --border: #1e293b;
            --gradient: linear-gradient(135deg, #34e89e 0%, #0fb9b1 100%);
        }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--navy); margin: 0; padding: 10px; color: var(--text); }
        .app-container { max-width: 450px; margin: 0 auto; padding-bottom: 100px; }
        .header h1 { text-align: center; font-size: 2.2rem; font-weight: 800; color: var(--white); margin: 15px 0; }
        .header h1 span { color: var(--sea); }

        .btn-gps { width: 100%; background: var(--gradient); color: var(--navy); border: none; padding: 16px; border-radius: 14px; font-weight: 800; cursor: pointer; margin-bottom: 15px; }
        .label { font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 6px; }
        
        #map { height: 180px; border-radius: 20px; margin-bottom: 15px; border: 2px solid var(--border); }
        .card { background: var(--card); border: 1px solid var(--border); padding: 18px; border-radius: 20px; margin-bottom: 15px; }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--white); box-sizing: border-box; }
        
        #intelBox { background: rgba(52, 232, 158, 0.1); border-left: 4px solid var(--sea); padding: 10px; margin-bottom: 10px; font-size: 0.8rem; display: none; }
        .undersize-tag { color: var(--red); font-weight: bold; border: 1px solid var(--red); padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; }

        .diary-item { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 15px; margin-bottom: 10px; display: flex; gap: 12px; position: relative; }
        .diary-img { width: 65px; height: 65px; border-radius: 10px; object-fit: cover; background: #000; }
        .diary-content { flex: 1; }
        .diary-actions { display: flex; gap: 10px; margin-top: 8px; }
        .action-link { font-size: 0.7rem; color: var(--text); text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header"><h1>Angler <span>OS</span></h1></div>
    <div id="map"></div>
    <button class="btn-gps" onclick="getLocation()">üìç NEAREST PORT</button>

    <div class="card" id="logCard">
        <span class="label" id="logTitle">Record a Catch</span>
        <div id="intelBox"></div>
        <input type="text" id="inSpecies" placeholder="Species (e.g. Bass, Cod, Ray)" oninput="runIntel()">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="number" id="inLen" placeholder="Length (cm)" oninput="runIntel()">
            <input type="number" id="inWt" placeholder="Weight">
        </div>
        <select id="inUnit"><option value="lb">Pounds (lb)</option><option value="kg">Kilos (kg)</option></select>
        
        <button class="btn-gps" style="background:var(--border); color:white; padding:10px; font-size:0.8rem;" onclick="document.getElementById('fIn').click()">üì∑ ADD PHOTO</button>
        <input type="file" id="fIn" hidden onchange="handleImg(this)">
        <img id="prevImg" style="width:100%; height:100px; object-fit:cover; border-radius:10px; margin-bottom:10px; display:none;">
        
        <button class="btn-gps" id="saveBtn" onclick="saveEntry()">üìñ SAVE TO DIARY</button>
        <button id="cancelBtn" style="display:none; width:100%; background:none; border:none; color:var(--red); cursor:pointer;" onclick="resetForm()">Cancel Edit</button>
    </div>

    <div id="diaryContainer"></div>
</div>

<script>
    const API_KEY = '05819e75195f4d5f8e73742dd5d57c39';
    const PROXY = "https://corsproxy.io/?";
    const BASE_URL = "https://admiraltyapi.azure-api.net/uktidalapi/api/V1";

    const REGS = {
        "bass": { mcrs: 42, info: "Max 3 fish daily (2026 rules)." },
        "cod": { mcrs: 35 }, "whiting": { mcrs: 27 }, "plaice": { mcrs: 27 },
        "pollack": { mcrs: 30, info: "New 2026 bag limits apply." },
        "smoothhound": { mcrs: 51 }, "ray": { mcrs: 40 }, "dogfish": { mcrs: 38 }
    };

    let catches = JSON.parse(localStorage.getItem('angler_os_logs')) || [];
    let allPorts = [], currentPort = "Unknown", currentTide = "--", tempImg = null, editIdx = -1;

    window.onload = () => {
        const map = L.map('map').setView([54, -3], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        loadPorts(); renderDiary();
    };

    async function loadPorts() {
        const res = await fetch(PROXY + encodeURIComponent(`${BASE_URL}/Stations`), { headers: { 'Ocp-Apim-Subscription-Key': API_KEY } });
        const data = await res.json();
        allPorts = data.features.map(f => ({ id: f.properties.Id, name: f.properties.Name, lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0] }));
    }

    function getLocation() {
        navigator.geolocation.getCurrentPosition(async pos => {
            let nearest = allPorts.reduce((prev, curr) => Math.hypot(prev.lat - pos.coords.latitude, prev.lon - pos.coords.longitude) < Math.hypot(curr.lat - pos.coords.latitude, curr.lon - pos.coords.longitude) ? prev : curr);
            currentPort = nearest.name;
            const res = await fetch(PROXY + encodeURIComponent(`${BASE_URL}/Stations/${nearest.id}/TidalEvents?duration=1`), { headers: { 'Ocp-Apim-Subscription-Key': API_KEY } });
            const tides = await res.json();
            const next = tides.find(t => new Date(t.DateTime) > new Date());
            currentTide = next ? `${next.EventType}` : "N/A";
            alert(`Location Set: ${currentPort}`);
        });
    }

    function runIntel() {
        const fish = document.getElementById('inSpecies').value.toLowerCase();
        const len = parseFloat(document.getElementById('inLen').value);
        const box = document.getElementById('intelBox');
        const key = Object.keys(REGS).find(s => fish.includes(s));
        if(key) {
            let html = REGS[key].info ? `<i>${REGS[key].info}</i><br>` : '';
            if(len) html += len >= REGS[key].mcrs ? `<span style="color:var(--sea)">‚úÖ Keeper Size</span>` : `<span style="color:var(--red)">‚ö†Ô∏è Undersize (Limit: ${REGS[key].mcrs}cm)</span>`;
            box.innerHTML = html; box.style.display = 'block';
        } else box.style.display = 'none';
    }

    function handleImg(input) {
        const reader = new FileReader();
        reader.onload = (e) => { tempImg = e.target.result; document.getElementById('prevImg').src = tempImg; document.getElementById('prevImg').style.display = 'block'; };
        reader.readAsDataURL(input.files[0]);
    }

    function saveEntry() {
        const species = document.getElementById('inSpecies').value;
        if(!species) return;
        const entry = {
            species, length: document.getElementById('inLen').value, 
            weight: document.getElementById('inWt').value, unit: document.getElementById('inUnit').value,
            photo: tempImg, port: currentPort, tide: currentTide,
            date: editIdx > -1 ? catches[editIdx].date : new Date().toLocaleString()
        };
        if(editIdx > -1) catches[editIdx] = entry; else catches.unshift(entry);
        localStorage.setItem('angler_os_logs', JSON.stringify(catches));
        resetForm(); renderDiary();
    }

    function renderDiary() {
        document.getElementById('diaryContainer').innerHTML = catches.map((c, i) => {
            const key = Object.keys(REGS).find(s => c.species.toLowerCase().includes(s));
            const isUnder = key && c.length && c.length < REGS[key].mcrs;
            return `
            <div class="diary-item">
                <img src="${c.photo || 'https://via.placeholder.com/65'}" class="diary-img">
                <div class="diary-content">
                    <div style="font-size:0.6rem; opacity:0.6;">${c.date} ‚Ä¢ ${c.port}</div>
                    <div style="font-weight:bold; color:white;">${c.species.toUpperCase()} ${c.length}cm</div>
                    <div style="font-size:0.75rem;">${c.weight}${c.unit} ‚Ä¢ ${c.tide}</div>
                    ${isUnder ? '<span class="undersize-tag">UNDERSIZE</span>' : ''}
                    <div class="diary-actions">
                        <span class="action-link" onclick="editEntry(${i})">‚úèÔ∏è Edit</span>
                        <span class="action-link" style="color:var(--red)" onclick="deleteEntry(${i})">üóëÔ∏è Delete</span>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function editEntry(i) {
        editIdx = i; const c = catches[i];
        document.getElementById('inSpecies').value = c.species;
        document.getElementById('inLen').value = c.length;
        document.getElementById('inWt').value = c.weight;
        document.getElementById('inUnit').value = c.unit;
        document.getElementById('logTitle').innerText = "Edit Entry";
        document.getElementById('saveBtn').innerText = "UPDATE ENTRY";
        document.getElementById('cancelBtn').style.display = 'block';
        window.scrollTo(0,0);
    }

    function deleteEntry(i) { if(confirm("Delete this catch?")) { catches.splice(i,1); localStorage.setItem('angler_os_logs', JSON.stringify(catches)); renderDiary(); } }
    function resetForm() { editIdx = -1; document.getElementById('logCard').querySelectorAll('input').forEach(i => i.value=''); document.getElementById('prevImg').style.display='none'; tempImg=null; document.getElementById('logTitle').innerText="Record a Catch"; document.getElementById('saveBtn').innerText="üìñ SAVE TO DIARY"; document.getElementById('cancelBtn').style.display='none'; }
</script>
</body>
</html>
