<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f41f.png">
    <title>Fishing Friend</title>
    <style>
        :root { --navy: #001f3f; --sea: #0074D9; --gold: #FFDC00; --bg: #f4f7f6; --red: #ff4136; --green: #2ecc40; --sky: #e1f5fe; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        .app-container { max-width: 480px; margin: 0 auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        
        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-hook { font-size: 40px; color: var(--navy); display: block; margin-bottom: 5px; }
        h1 { color: var(--navy); margin: 0; font-size: 1.6rem; letter-spacing: -1px; }

        .label { font-size: 0.7rem; font-weight: bold; color: #999; text-transform: uppercase; letter-spacing: 1px; }
        input, select { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        #favBar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .fav-tag { background: var(--navy); color: white; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: none; }
        
        .card { background: #fff; border: 1px solid #f0f0f0; padding: 15px; border-radius: 15px; margin-bottom: 15px; position: relative; border-left: 5px solid var(--sea); }
        .val { font-size: 1.8rem; font-weight: 800; color: var(--navy); margin: 2px 0; }
        .sub-val { font-size: 0.9rem; font-weight: 600; color: var(--sea); }
        
        .tide-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f5f5f5; }
        .high { color: var(--green); font-weight: bold; }
        .low { color: #ff851b; font-weight: bold; }
        
        .star { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.6rem; cursor: pointer; color: #ddd; }
        .star.active { color: var(--gold); }
        .loading { text-align: center; font-weight: bold; color: var(--sea); padding: 10px; display: none; }
        
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: bold; margin-top: 5px; }
        .flood { background: var(--sky); color: var(--sea); border: 1px solid var(--sea); }
        .ebb { background: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="logo-container">
        <span class="logo-hook">ü™ù</span>
        <h1>Fishing Friend</h1>
    </div>

    <div id="favBar"></div>
    <div style="margin-bottom:20px;">
        <span class="label">Select Port</span>
        <input type="text" id="searchBox" placeholder="Search ports..." oninput="filterStations()">
        <select id="stationSelect" onchange="loadData()"><option>Loading...</option></select>
    </div>
    
    <div id="loader" class="loading">üì° Syncing Sea Conditions...</div>

    <div id="dashboard">
        <div class="grid-2">
            <div class="card">
                <span class="label">Wind</span>
                <div class="val" id="windSpd">--</div>
                <div class="sub-val" id="windDir">--</div>
            </div>
            <div class="card" style="border-left-color: #0074D9;">
                <span class="label">Waves</span>
                <div class="val" id="waveHgt">--</div>
                <div class="sub-val" id="wavePeriod">--</div>
            </div>
        </div>

        <div class="card" style="border-left-color: var(--gold);">
            <button id="starBtn" class="star" onclick="toggleFav()">‚òÖ</button>
            <span class="label">Current / Flow</span>
            <div class="val" id="curSpd">--</div>
            <div id="tideStatus">--</div>
        </div>

        <div class="card" style="border-left-color: var(--green);">
            <span class="label">Tide Schedule</span>
            <div id="tideList"><p style="color:#ccc; font-size:0.85rem;">Select a port...</p></div>
        </div>
    </div>
</div>

<script>
    const KEY = '05819e75195f4d5f8e73742dd5d57c39';
    const PROXY = "https://corsproxy.io/?"; 
    const API_BASE = "https://admiraltyapi.azure-api.net/uktidalapi/api/V1";

    let allStations = [];
    let currentID = null;
    let favs = JSON.parse(localStorage.getItem('fishingFavs')) || [];

    window.onload = () => { getStations(); drawFavs(); };

    async function getStations() {
        try {
            const target = `${API_BASE}/Stations`;
            const res = await fetch(PROXY + encodeURIComponent(target), { headers: { 'Ocp-Apim-Subscription-Key': KEY } });
            const data = await res.json();
            allStations = data.features.map(f => ({
                Id: f.properties.Id, Name: f.properties.Name, Coords: f.geometry.coordinates
            })).sort((a, b) => a.Name.localeCompare(b.Name));
            fillSelect(allStations);
        } catch (e) { console.error(e); }
    }

    function fillSelect(data) {
        const s = document.getElementById('stationSelect');
        s.innerHTML = '<option value="">-- Choose Port --</option>';
        data.forEach(item => {
            const el = document.createElement('option');
            el.value = item.Id; el.textContent = item.Name; s.appendChild(el);
        });
    }

    async function loadData(sid = null) {
        const id = sid || document.getElementById('stationSelect').value;
        if (!id) return;
        currentID = id;
        document.getElementById('loader').style.display = 'block';
        updateStar();
        const stn = allStations.find(x => x.Id === id);
        const [lon, lat] = stn.Coords;

        try {
            // 1. Tides
            const tRes = await fetch(PROXY + encodeURIComponent(`${API_BASE}/Stations/${id}/TidalEvents`), { headers: { 'Ocp-Apim-Subscription-Key': KEY } });
            const tides = await tRes.json();

            // 2. Wind (Standard Weather API)
            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=wind_speed_10m,wind_direction_10m&wind_speed_unit=mph`);
            const wind = await wRes.json();

            // 3. Marine Data (Waves & Currents)
            const mRes = await fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&current=wave_height,wave_period,ocean_current_velocity,ocean_current_direction`);
            const marine = await mRes.json();

            render(tides, wind.current, marine.current, stn.Name);
        } catch (err) { 
            console.error(err);
            alert("Coastal data unavailable for this specific location.");
        } finally { document.getElementById('loader').style.display = 'none'; }
    }

    function render(tides, wind, marine, name) {
        const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
        
        // Render Wind
        const wDir = dirs[Math.round(wind.wind_direction_10m / 22.5) % 16];
        document.getElementById('windSpd').innerText = `${Math.round(wind.wind_speed_10m)} mph`;
        document.getElementById('windDir').innerText = `${wDir} (${wind.wind_direction_10m}¬∞)`;

        // Render Marine (Waves convert to feet)
        const waveFt = (marine.wave_height * 3.28084).toFixed(1);
        document.getElementById('waveHgt').innerText = `${waveFt} ft`;
        document.getElementById('wavePeriod').innerText = `${marine.wave_period}s period`;

        // Render Current (m/s to knots: 1.94)
        const curKts = (marine.ocean_current_velocity * 1.94384).toFixed(1);
        const cDir = dirs[Math.round(marine.ocean_current_direction / 22.5) % 16];
        document.getElementById('curSpd').innerText = `${curKts} kts ${cDir}`;

        // Tide Logic
        const now = new Date();
        const futureTides = tides.filter(t => new Date(t.DateTime) > now);
        const nextTide = futureTides[0];
        const statusEl = document.getElementById('tideStatus');
        
        if (nextTide) {
            const isFlooding = nextTide.EventType.includes("High");
            statusEl.innerHTML = isFlooding ? 
                `<div class="status-badge flood">üåä FLOODING (Pushing In)</div>` : 
                `<div class="status-badge ebb">üìâ EBBING (Going Out)</div>`;
        }

        const list = document.getElementById('tideList');
        list.innerHTML = futureTides.slice(0, 4).map(t => {
            const tDate = new Date(t.DateTime);
            const isHigh = t.EventType.includes("High");
            const timeStr = tDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            return `<div class="tide-row">
                <span class="${isHigh?'high':'low'}">${isHigh?'HIGH':'LOW'}</span>
                <span>${timeStr}</span>
                <span>${t.Height.toFixed(2)}m</span>
            </div>`;
        }).join('');
    }

    // Standard Helper Functions
    function toggleFav() {
        const idx = favs.findIndex(f => f.id === currentID);
        if (idx > -1) favs.splice(idx, 1);
        else {
            const stn = allStations.find(x => x.Id === currentID);
            favs.push({id: stn.Id, name: stn.Name});
        }
        localStorage.setItem('fishingFavs', JSON.stringify(favs));
        drawFavs(); updateStar();
    }
    function drawFavs() { document.getElementById('favBar').innerHTML = favs.map(f => `<button class="fav-tag" onclick="loadData('${f.id}')">${f.name}</button>`).join(''); }
    function updateStar() { const btn = document.getElementById('starBtn'); if (btn) btn.className = favs.some(f => f.id === currentID) ? 'star active' : 'star'; }
    function filterStations() { const q = document.getElementById('searchBox').value.toLowerCase(); fillSelect(allStations.filter(x => x.Name.toLowerCase().includes(q))); }
</script>
</body>
</html>
