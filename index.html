<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Friend Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { 
            --navy: #050b14; --card: #121c2b; --sea: #34e89e; 
            --gold: #f4af1b; --white: #f1f2f6; --text: #cbd5e0; 
            --red: #ff4757; --border: #1e293b;
            --gradient: linear-gradient(135deg, #34e89e 0%, #0fb9b1 100%);
        }
        
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--navy); margin: 0; padding: 10px; color: var(--text); }
        .app-container { max-width: 450px; margin: 0 auto; background: var(--navy); padding: 15px; border-radius: 30px; box-sizing: border-box; }
        
        .header { text-align: center; margin-bottom: 25px; padding-top: 15px; }
        .header h1 { margin: 0; font-size: 2.2rem; font-weight: 900; text-transform: uppercase; letter-spacing: -1.5px; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 3px; font-weight: 700; }

        .btn-gps { width: 100%; background: var(--gradient); color: var(--navy); border: none; padding: 16px; border-radius: 14px; font-weight: 800; cursor: pointer; margin-bottom: 20px; font-size: 1rem; }
        .label { font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 8px; }
        
        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border: 2px solid var(--border); border-radius: 14px; background: var(--card); color: var(--white); box-sizing: border-box; outline: none; }

        #favBar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .fav-tag { background: #1e293b; color: var(--sea); padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; border: 1px solid var(--border); cursor: pointer; }
        
        .card { background: var(--card); border: 1px solid var(--border); padding: 18px; border-radius: 20px; margin-bottom: 12px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .val { font-size: 1.4rem; font-weight: 800; color: var(--white); display: flex; align-items: center; gap: 6px; }
        .sub-val { font-size: 0.8rem; font-weight: 600; color: var(--sea); margin-top: 4px; }
        
        #map { height: 200px; width: 100%; border-radius: 20px; margin-bottom: 15px; border: 2px solid var(--border); }
        .rating-box { padding: 15px; border-radius: 15px; text-align: center; font-weight: 900; margin-bottom: 12px; border: 2px solid transparent; }
        .good { background: rgba(52, 232, 158, 0.1); color: var(--sea); border-color: var(--sea); }
        .fair { background: rgba(244, 175, 27, 0.1); color: var(--gold); border-color: var(--gold); }
        
        .tide-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .btn-outline { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid var(--sea); background: transparent; color: var(--sea); border-radius: 12px; font-weight: bold; cursor: pointer; }
        
        /* Catch Log Styles */
        .log-item { background: var(--navy); padding: 10px; border-radius: 10px; margin-top: 8px; border-left: 4px solid var(--sea); font-size: 0.85rem; }
        .btn-log { background: var(--gold); color: var(--navy); border: none; width: 100%; padding: 12px; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>FISHING FRIEND</h1>
        <span class="subtitle">Pro Intelligence</span>
    </div>

    <button class="btn-gps" onclick="getLocation()">üìç Locate Nearest Port</button>

    <div class="search-section">
        <div id="favBar"></div>
        <input type="text" id="searchBox" placeholder="Search port..." oninput="filterStations()">
        <select id="stationSelect" onchange="loadData()"><option>-- Select Port --</option></select>
    </div>

    <div id="dashboard" style="display:none;">
        <div id="map"></div>
        <div id="fishingRating" class="rating-box">Analysing...</div>

        <div class="card" style="border-color: var(--gold);">
            <span class="label" style="color: var(--gold);">Pro Intelligence</span>
            <div class="grid-2">
                <div>
                    <div class="val" id="pressure">-- hPa</div>
                    <div class="sub-val" id="pressureTrend">Steady</div>
                </div>
                <div>
                    <div class="val" id="moonPhase">--</div>
                    <div class="sub-val" id="lunarPower">Lunar Power: --</div>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <span class="label">Weather</span>
                <div class="val" id="temp">--¬∞C</div>
                <div id="clouds" class="sub-val">--</div>
            </div>
            <div class="card">
                <span class="label">Wind</span>
                <div class="val"><span id="windSpd">--</span> <span id="windArrow">‚Üë</span></div>
                <div id="windDirLabel" class="sub-val">--</div>
            </div>
        </div>

        <div class="card">
            <span class="label">Tidal Schedule</span>
            <div id="tideList"></div>
            <button class="btn-outline" onclick="toggleExtendedTides()">üìÖ 7-Day Outlook</button>
            <div id="extendedTides" style="display:none;"></div>
        </div>

        <div class="card">
            <span class="label">Your Catch Log</span>
            <div id="catchList"></div>
            <button class="btn-log" onclick="addCatch()">üé£ LOG CURRENT SESSION</button>
        </div>
    </div>
</div>

<script>
    const KEY = '05819e75195f4d5f8e73742dd5d57c39';
    const PROXY = "https://corsproxy.io/?"; 
    const API_BASE = "https://admiraltyapi.azure-api.net/uktidalapi/api/V1";

    let allStations = [], currentID = null, map = null, marker = null;
    let catches = JSON.parse(localStorage.getItem('fishingCatches')) || [];

    window.onload = () => { initMap(); getStations(); renderCatches(); };

    function initMap() {
        map = L.map('map', {zoomControl: false, attributionControl: false}).setView([54, -2], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    }

    async function getStations() {
        const res = await fetch(PROXY + encodeURIComponent(`${API_BASE}/Stations`), { headers: { 'Ocp-Apim-Subscription-Key': KEY } });
        const data = await res.json();
        allStations = data.features.map(f => ({ Id: f.properties.Id, Name: f.properties.Name, Coords: f.geometry.coordinates })).sort((a,b) => a.Name.localeCompare(b.Name));
        fillSelect(allStations);
    }

    async function loadData(sid = null) {
        const id = sid || document.getElementById('stationSelect').value;
        currentID = id;
        document.getElementById('dashboard').style.display = 'block';
        const stn = allStations.find(x => x.Id === id);
        const [lon, lat] = stn.Coords;

        map.setView([lat, lon], 12);
        if (marker) marker.setLatLng([lat, lon]); else marker = L.marker([lat, lon]).addTo(map);

        // Fetch Weather + Pressure
        const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,surface_pressure,wind_speed_10m,wind_direction_10m&hourly=surface_pressure`);
        const weather = await wRes.json();
        
        // Fetch Tides
        const tRes = await fetch(PROXY + encodeURIComponent(`${API_BASE}/Stations/${id}/TidalEvents?duration=7`), { headers: { 'Ocp-Apim-Subscription-Key': KEY } });
        const tides = await tRes.json();

        renderPro(weather, tides, stn.Name);
    }

    function renderPro(w, tides, name) {
        // Pressure
        const p = w.current.surface_pressure;
        document.getElementById('pressure').innerText = `${Math.round(p)} hPa`;
        const trend = p > 1013 ? "High (Clear)" : "Low (Feeding)";
        document.getElementById('pressureTrend').innerText = trend;

        // Simple Moon Phase Calculation (Approx)
        const phases = ["üåë New", "üåí Crescent", "üåì Quarter", "üåî Gibbous", "üåï Full", "üåñ Gibbous", "üåó Quarter", "üåò Crescent"];
        const day = new Date().getDate();
        const phase = phases[day % 8];
        document.getElementById('moonPhase').innerText = phase;
        document.getElementById('lunarPower').innerText = (phase.includes("Full") || phase.includes("New")) ? "Lunar Power: STRONG" : "Lunar Power: MODERATE";

        // Wind & Temp
        document.getElementById('temp').innerText = `${Math.round(w.current.temperature_2m)}¬∞C`;
        document.getElementById('windSpd').innerText = `${Math.round(w.current.wind_speed_10m)} mph`;
        document.getElementById('windArrow').style.transform = `rotate(${w.current.wind_direction_10m}deg)`;

        // Tides
        const future = tides.filter(t => new Date(t.DateTime) > new Date());
        document.getElementById('tideList').innerHTML = future.slice(0, 3).map(t => `
            <div class="tide-row">
                <span style="color:${t.EventType.includes('High')?'#34e89e':'#f4af1b'}">${t.EventType.toUpperCase()}</span>
                <span>${new Date(t.DateTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
            </div>
        `).join('');
        
        const rating = document.getElementById('fishingRating');
        rating.innerText = (p < 1015 && future[0].EventType.includes("High")) ? "üèÜ ELITE CONDITIONS" : "üé£ GOOD CHANCE";
        rating.className = "rating-box good";
    }

    function addCatch() {
        const name = allStations.find(x => x.Id === currentID).Name;
        const entry = { port: name, time: new Date().toLocaleString() };
        catches.unshift(entry);
        localStorage.setItem('fishingCatches', JSON.stringify(catches));
        renderCatches();
    }

    function renderCatches() {
        document.getElementById('catchList').innerHTML = catches.slice(0, 3).map(c => `
            <div class="log-item"><b>${c.port}</b><br><small>${c.time}</small></div>
        `).join('');
    }

    function fillSelect(data) {
        const s = document.getElementById('stationSelect');
        s.innerHTML = '<option value="">-- Select Port --</option>';
        data.forEach(item => { s.innerHTML += `<option value="${item.Id}">${item.Name}</option>`; });
    }

    function filterStations() {
        const q = document.getElementById('searchBox').value.toLowerCase();
        fillSelect(allStations.filter(x => x.Name.toLowerCase().includes(q)));
    }

    function toggleExtendedTides() {
        const div = document.getElementById('extendedTides');
        div.style.display = div.style.display === 'none' ? 'block' : 'none';
    }
</script>
</body>
</html>
